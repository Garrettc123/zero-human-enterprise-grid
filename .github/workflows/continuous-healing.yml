name: Continuous Healing

on:
  workflow_dispatch:
    inputs:
      sync_scope:
        description: 'Sync Scope'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - cloud
          - database
          - storage
          - cache
          - messaging
      dry_run:
        description: 'Dry Run (no actual changes)'
        required: false
        default: false
        type: boolean

  schedule:
    # Run every hour
    - cron: '0 * * * *'

jobs:
  mega-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Health Check
        run: |
          echo "üè• Running system health checks..."
          python -c "
          from monitoring import SystemMonitor
          monitor = SystemMonitor()
          health = monitor.check_health()
          print(f'System Status: {health[\"status\"]}')
          print(f'Active Systems: {health[\"active_systems\"]}/{health[\"total_systems\"]}')
          "

      - name: üîÑ Run Mega Sync Orchestrator
        env:
          SYNC_SCOPE: ${{ github.event.inputs.sync_scope || 'all' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          # Cloud Providers
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          # Databases
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          # Storage
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          # Cache
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          echo "üéØ Starting Mega Sync Orchestrator"
          echo "Scope: $SYNC_SCOPE"
          echo "Dry Run: $DRY_RUN"
          python run_mega_sync.py --scope $SYNC_SCOPE

      - name: üìä Generate Sync Report
        if: always()
        run: |
          echo "üìà Generating sync report..."
          python -c "
          from monitoring import SystemMonitor
          monitor = SystemMonitor()
          report = monitor.generate_report()
          print('\n=== SYNC REPORT ===')
          for system, metrics in report.items():
              print(f'\n{system}:')
              print(f'  Status: {metrics.get(\"status\", \"unknown\")}')
              print(f'  Last Sync: {metrics.get(\"last_sync\", \"never\")}')
              print(f'  Success Rate: {metrics.get(\"success_rate\", 0)}%')
          "

      - name: üö® Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Sync failed! Check logs for details."
          echo "::error::Continuous Healing workflow failed"

      - name: ‚úÖ Success Summary
        if: success()
        run: |
          echo "‚úÖ Continuous Healing completed successfully!"
          echo "All systems synchronized and operational."

  monitor-health:
    runs-on: ubuntu-latest
    needs: mega-sync
    if: always()
    
    steps:
      - name: üè• Post-Sync Health Check
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install monitoring tools
        run: |
          pip install -r requirements.txt
          
      - name: Run comprehensive health check
        run: |
          python -c "
          from monitoring import SystemMonitor
          import json
          
          monitor = SystemMonitor()
          health = monitor.check_health()
          
          print('\nüè• COMPREHENSIVE HEALTH CHECK')
          print('=' * 50)
          print(json.dumps(health, indent=2))
          
          if health['status'] != 'healthy':
              print('\n‚ö†Ô∏è  WARNING: System health degraded')
              exit(1)
          else:
              print('\n‚úÖ All systems healthy!')
          "
